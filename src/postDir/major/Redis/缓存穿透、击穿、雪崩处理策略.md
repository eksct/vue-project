è¿™æ˜¯ Redis åœ¨å®é™…ç”Ÿäº§ä¸­**ä¸‰å¤§å¸¸è§ç¼“å­˜é—®é¢˜**ï¼š**ç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©**ï¼Œå¦‚æœä¸å¤„ç†å¥½ï¼Œè½»åˆ™æ€§èƒ½æŠ–åŠ¨ï¼Œé‡åˆ™æ•°æ®åº“å´©æºƒã€‚ä¸‹é¢æˆ‘è¯¦ç»†ç»™ä½ æ¢³ç†è¿™ä¸‰è€…çš„**å®šä¹‰ + äº§ç”ŸåŸå›  + è§£å†³æ–¹æ¡ˆï¼ˆé™„ä»£ç /è®¾è®¡æ€è·¯ï¼‰**ã€‚

---

# ğŸ” ä¸€ã€ç¼“å­˜ç©¿é€ï¼ˆCache Penetrationï¼‰

### âœ… æ¦‚å¿µï¼š

è¯·æ±‚çš„æ•°æ® **åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œæ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨**ï¼Œæ¯æ¬¡éƒ½ä¼šå»æŸ¥æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å‹åŠ›å‰§å¢ã€‚

---

### ğŸš¨ åœºæ™¯ï¼š

- ç”¨æˆ·è¯·æ±‚ä¸€ä¸ª `userId = -9999` çš„æ•°æ®ï¼ŒRedis æ²¡æœ‰ï¼Œæ•°æ®åº“ä¹Ÿæ²¡æœ‰ã€‚
    
- æ¯æ¬¡è¯·æ±‚éƒ½ç›´è¾¾æ•°æ®åº“ï¼Œç»•è¿‡ç¼“å­˜ã€‚
    

---

### âœ… è§£å†³æ–¹æ¡ˆï¼š

#### âœ… 1. ç¼“å­˜ç©ºå€¼ï¼ˆæ¨èï¼‰

å½“æ•°æ®åº“è¿”å›ç©ºç»“æœæ—¶ï¼Œä¹Ÿå†™å…¥ç¼“å­˜ï¼š

```java
// æŸ¥è¯¢ç¼“å­˜
String val = redis.get(key);
if (val == null) {
    Object dbVal = db.query(key);
    if (dbVal == null) {
        redis.setex(key, "NULL", 60); // ç¼“å­˜ç©ºå€¼ï¼Œè¿‡æœŸæ—¶é—´çŸ­
        return null;
    } else {
        redis.set(key, dbVal, 3600);
        return dbVal;
    }
}
```

#### âœ… 2. ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå¤§è§„æ¨¡ç©¿é€ï¼‰

ç”¨å¸ƒéš†è¿‡æ»¤å™¨ç»´æŠ¤æ‰€æœ‰åˆæ³• key çš„é›†åˆï¼Œæå‰æ‹¦æˆªéæ³•è¯·æ±‚ã€‚

```java
if (!bloomFilter.mightContain(key)) {
    return null; // æ ¹æœ¬ä¸å¯èƒ½å­˜åœ¨
}
```

---

# âš¡ äºŒã€ç¼“å­˜å‡»ç©¿ï¼ˆCache Breakdownï¼‰

### âœ… æ¦‚å¿µï¼š

**æŸä¸ªçƒ­ç‚¹ key å¤±æ•ˆçš„ç¬é—´**ï¼Œå¤§é‡è¯·æ±‚åŒæ—¶åˆ°æ¥ï¼Œè¯·æ±‚å…¨æ‰“åœ¨æ•°æ®åº“ä¸Šï¼Œç¬é—´æŠŠæ•°æ®åº“å‹å®ã€‚

---

### ğŸš¨ åœºæ™¯ï¼š

- æŸä¸ªçƒ­ç‚¹å•†å“ç§’æ€ä¿¡æ¯å¤±æ•ˆï¼Œå‡ ä¸‡è¯·æ±‚ç¬é—´è®¿é—® DBã€‚
    

---

### âœ… è§£å†³æ–¹æ¡ˆï¼š

#### âœ… 1. åŠ äº’æ–¥é”ï¼ˆæ¨èï¼‰

é˜²æ­¢å¤§é‡è¯·æ±‚åŒæ—¶å›æºæ•°æ®åº“ï¼š

```java
if (redis.get(key) == null) {
    // åˆ†å¸ƒå¼é”
    if (tryLock("lock:" + key)) {
        try {
            // åªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥åº“å¹¶å†™ç¼“å­˜
            Object dbData = db.query(key);
            redis.set(key, dbData, 60 * 60);
        } finally {
            releaseLock("lock:" + key);
        }
    } else {
        // å…¶ä»–çº¿ç¨‹ç­‰å¾…æˆ–å¿«é€Ÿå¤±è´¥
        Thread.sleep(50);
        return redis.get(key);
    }
}
```

> å¯ä»¥ç”¨ Redisson æä¾›çš„ `RLock` å®ç°åˆ†å¸ƒå¼é”ã€‚

#### âœ… 2. æ°¸ä¸è¿‡æœŸ + å¼‚æ­¥æ›´æ–°ï¼ˆç¼“å­˜é¢„çƒ­/åˆ·æ–°ç­–ç•¥ï¼‰

- çƒ­ç‚¹æ•°æ®è®¾ç½®ä¸ºæ°¸ä¸è¿‡æœŸï¼Œåå°å®šæ—¶åˆ·æ–°ã€‚
    

---

# ğŸŒ¨ ä¸‰ã€ç¼“å­˜é›ªå´©ï¼ˆCache Avalancheï¼‰

### âœ… æ¦‚å¿µï¼š

**å¤§é‡ç¼“å­˜åŒä¸€æ—¶é—´è¿‡æœŸæˆ–å¤±æ•ˆ**ï¼Œå¯¼è‡´è¯·æ±‚é›†ä¸­æ‰“åˆ°æ•°æ®åº“ï¼Œç³»ç»Ÿå´©æºƒã€‚

---

### ğŸš¨ åœºæ™¯ï¼š

- ç³»ç»Ÿé‡å¯åæ‰€æœ‰ç¼“å­˜ä¸€èµ·å¤±æ•ˆ
    
- æ‰€æœ‰ key è®¾ç½®äº†åŒæ ·çš„ TTLï¼Œåˆ°äº†å°±ä¸€èµ·å¤±æ•ˆ
    

---

### âœ… è§£å†³æ–¹æ¡ˆï¼š

#### âœ… 1. è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶åŠ éšæœºå€¼ï¼ˆæ¨èï¼‰

```java
redis.set(key, value, 3600 + random.nextInt(300));
```

> é¿å…æ‰€æœ‰ key åŒæ—¶è¿‡æœŸï¼Œç¼“è§£å‹åŠ›ã€‚

#### âœ… 2. åšæ•°æ®é¢„çƒ­

ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œæå‰å°†çƒ­ç‚¹æ•°æ®åŠ è½½è¿› Redisã€‚

#### âœ… 3. å¼‚æ­¥å»¶è¿ŸåŒå†™æœºåˆ¶ï¼ˆé¢„é˜²æ€§åˆ·æ–°ï¼‰

- æå‰æ‰¹é‡åˆ·æ–°å³å°†è¿‡æœŸçš„ key
    
- é…åˆé˜Ÿåˆ—/å®šæ—¶ä»»åŠ¡å¼‚æ­¥æ›´æ–°
    

---

# âœ… æ€»ç»“å¯¹æ¯”è¡¨

| é—®é¢˜  | è§¦å‘æ¡ä»¶                  | å½±å“          | è§£å†³æ–¹æ¡ˆ             |
| --- | --------------------- | ----------- | ---------------- |
| ç©¿é€  | è¯·æ±‚ä¸å­˜åœ¨çš„ key            | æ¯æ¬¡ç©¿è¿‡ç¼“å­˜ç›´è¾¾æ•°æ®åº“ | ç¼“å­˜ç©ºå€¼ã€å¸ƒéš†è¿‡æ»¤å™¨       |
| å‡»ç©¿  | çƒ­ç‚¹ key è¿‡æœŸç¬é—´           | å¤§é‡è¯·æ±‚åŒæ—¶æ‰“ç©¿æ•°æ®åº“ | åˆ†å¸ƒå¼é”ã€æ°¸ä¸è¿‡æœŸ + å¼‚æ­¥åˆ·æ–° |
| é›ªå´©  | å¤§é‡ key åŒæ—¶è¿‡æœŸæˆ– Redis å®•æœº | è¯·æ±‚æ´ªå³°å‹å®æ•°æ®åº“   | éšæœº TTLã€é¢„çƒ­ã€é™æµã€ç†”æ–­  |
redis+redissoné˜²å‡»ç©¿æ¨¡æ¿
```java
@Service
public class CacheService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    @Autowired
    private RedissonClient redissonClient;

    /**
     * è·å–æ•°æ®ï¼Œå¸¦ç¼“å­˜å‡»ç©¿é˜²æŠ¤
     */
    public Object getDataWithLock(String key) {
        // 1. å…ˆæŸ¥ç¼“å­˜
        Object cacheData = redisTemplate.opsForValue().get(key);
        if (cacheData != null) {
            return cacheData;
        }

        // 2. ç¼“å­˜æ²¡æœ‰ï¼Œå°è¯•åŠ é”
        String lockKey = "lock:" + key;
        RLock lock = redissonClient.getLock(lockKey);

        try {
            // tryLock(ç­‰å¾…æ—¶é—´, é”è¿‡æœŸæ—¶é—´, å•ä½)
            if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
                try {
                    // 3. åŒé‡æ£€æŸ¥ï¼Œé¿å…é‡å¤æŸ¥åº“
                    Object doubleCheck = redisTemplate.opsForValue().get(key);
                    if (doubleCheck != null) {
                        return doubleCheck;
                    }

                    // 4. æŸ¥æ•°æ®åº“
                    Object dbData = queryDB(key);

                    if (dbData == null) {
                        // é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šå†™ä¸€ä¸ªçŸ­æœŸç©ºå€¼
                        redisTemplate.opsForValue().set(key, "NULL", 1, TimeUnit.MINUTES);
                        return null;
                    }

                    // 5. å†™ç¼“å­˜ï¼ˆåŠ ä¸Šéšæœº TTLï¼Œé¿å…é›ªå´©ï¼‰
                    int ttl = 30 + new Random().nextInt(10); // 30~40 åˆ†é’Ÿ
                    redisTemplate.opsForValue().set(key, dbData, ttl, TimeUnit.MINUTES);
                    return dbData;

                } finally {
                    lock.unlock(); // é‡Šæ”¾é”
                }
            } else {
                // è·å–é”å¤±è´¥ï¼šç¨ç­‰å†è¯»ç¼“å­˜
                Thread.sleep(50);
                return redisTemplate.opsForValue().get(key);
            }
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    /**
     * æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
     */
    private Object queryDB(String key) {
        System.out.println("æŸ¥è¯¢æ•°æ®åº“: " + key);
        return "value-for-" + key;
    }
}

```